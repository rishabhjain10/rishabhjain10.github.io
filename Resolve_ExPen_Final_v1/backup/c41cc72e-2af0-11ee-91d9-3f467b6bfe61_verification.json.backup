{"default_url":null,"content":{"state":2,"taskInstructions":"<h2>Instructions</h2><br>Identify internal, managed, and federated active directory domains.<br><br>The Autodiscover service minimizes user configuration and deployment steps by providing clients access to Exchange features. For Exchange Web Services (EWS) clients, Autodiscover is typically used to find the EWS endpoint URL. However, Autodiscover can also provide information to configure clients that use other protocols. Autodiscover works for client applications that are inside or outside firewalls and in resource forest and multiple forest scenarios.<br><br>As part of this service, an RPC over HTTP (&quot;Outlook Anywhere&quot;) feature can be configured, resulting in the presence of the https://autodiscover.domain.com/rpc URL.  RPC over HTTP, also known as Outlook Anywhere, is a legacy method of connectivity and transport between Outlook for Windows and Exchange. In May 2014, Microsoft introduced MAPI over HTTP as a replacement for RPC over HTTP. <br><br>Starting on October 31, 2017, RPC over HTTP will no longer be a supported protocol for accessing mail data from Exchange Online. However, organizations may still support this feature depending on their Exchange configuration.<br><br><h2>Variation: Manual Process using Burp</h2><br>1. Start Burp and proxy your browser traffic through it.<br><br>2. For each domain enumerated in scope attempt to access the autodiscover subdomain's RPC URL to identify potential Active Directory domains.<br><h3>Example:</h3><br><code>https://autodiscover.domain.com/rpc<br></code><br>3. When prompted for credentials by the website, enter any username/password combination (invalid credentials are fine).<br><br>4. Copy the value (bold portion below) from the WWW-Authenticate header that is returned by the server.<br><h3>Example:</h3><br><code>WWW-Authenticate: NTLM <b>TlRMTVNTUAACAAAABgAGADgAAAAFgomiwRzZSRUKShsAAAAAAAAAAK4ArgA+AAAACgA5OAAAAA9BAE0AUwACAAYAQQBNAFMAAQASAFcAMAAwADkANQBBAFAAMgAwAAQAIgBhAG0AcwAuAGIAbgB5AG0AZQBsAGwAbwBuAC4AbgBlAHQAAwA2AFcAMAAwADkANQBBAFAAMgAwAC4AYQBtAHMALgBiAG4AeQBtAGUAbABsAG8AbgAuAG4AZQB0AAUAGgBiAG4AeQBtAGUAbABsAG8AbgAuAG4AZQB0AAcACAD7qrDJRlzVAQAAAAA=</b><br></code><br>5. Base64-decode the value and review it for internal domain names. Note that not all characters will be printable:<br><h3>Example:</h3><br><code><b>&#35; echo &quot;TlRMTVNTUAACAAAABgAGADgAAAAFgomiwRzZSRUKShsAAAAAAAAAAK4ArgA+AAAACgA5OAAAAA9BAE0AUwACAAYAQQBNAFMAAQASAFcAMAAwADkANQBBAFAAMgAwAAQAIgBhAG0AcwAuAGIAbgB5AG0AZQBsAGwAbwBuAC4AbgBlAHQAAwA2AFcAMAAwADkANQBBAFAAMgAwAC4AYQBtAHMALgBiAG4AeQBtAGUAbABsAG8AbgAuAG4AZQB0AAUAGgBiAG4AeQBtAGUAbABsAG8AbgAuAG4AZQB0AAcACAD7qrDJRlzVAQAAAAA=&quot; | base64 -d</b><br>NTLMSSP8<br>98AMSAMSW0095AP20&quot;<b><red>subdomain.domain.com</red></b>6W0095AP20.subdomain.domain.comdomain.com<br></code><br><h2><b>Reporting Requirements</b></h2><br>Report the ADS domains in the task notes.<br>","references":[],"isTaskInstructionsVisible":true,"isCommentMandatory":false,"fields":[],"masterFinding":{"id":17063468,"exploitInstructions":"","verificationInstructions":"<h2><b>Instructions</b></h2><br>1. Identify interfaces that support NTLM.<br>2. Send authenticated request.<br>3. Parse information from the response.<br>4. If its possible to leak information, add the associated finding, and add verification that has the command and output.<br><h2></h2><br><h2><b>For Autodiscover:</b></h2><br> Identify internal, managed, and federated active directory domains.<br><br>The Autodiscover service minimizes user configuration and deployment steps by providing clients access to Exchange features. For Exchange Web Services (EWS) clients, Autodiscover is typically used to find the EWS endpoint URL. However, Autodiscover can also provide information to configure clients that use other protocols. Autodiscover works for client applications that are inside or outside firewalls and in resource forest and multiple forest scenarios.<br><br>As part of this service, an RPC over HTTP (&quot;Outlook Anywhere&quot;) feature can be configured, resulting in the presence of the https://autodiscover.domain.com/rpc URL.  RPC over HTTP, also known as Outlook Anywhere, is a legacy method of connectivity and transport between Outlook for Windows and Exchange. In May 2014, Microsoft introduced MAPI over HTTP as a replacement for RPC over HTTP. <br>Starting on October 31, 2017, RPC over HTTP will no longer be a supported protocol for accessing mail data from Exchange Online. However, organizations may still support this feature depending on their Exchange configuration.<br><br><h3>Variation: Manual Process using Burp</h3><br>1. Start Burp and proxy your browser traffic through it.<br>2. For each domain enumerated in scope attempt to access the autodiscover subdomain's RPC URL to identify potential Active Directory domains.<br><i>Example:</i>https://autodiscover.domain.com/rpc<br>3. When prompted for credentials by the website, enter any username/password combination (invalid credentials are fine).<br>4. Copy the value (bolded portion below) from the WWW-Authenticate header that is returned by the server.<br><i>Example:</i><br><code>WWW-Authenticate: NTLM <b>TlRMTVNTUAACAAAABgAGADgAAAAFgomiwRzZSRUKShsAAAAAAAAAAK4ArgA+AAAACgA5OAAAAA9BAE0AUwACAAYAQQBNAFMAAQASAFcAMAAwADkANQBBAFAAMgAwAAQAIgBhAG0AcwAuAGIAbgB5AG0AZQBsAGwAbwBuAC4AbgBlAHQAAwA2AFcAMAAwADkANQBBAFAAMgAwAC4AYQBtAHMALgBiAG4AeQBtAGUAbABsAG8AbgAuAG4AZQB0AAUAGgBiAG4AeQBtAGUAbABsAG8AbgAuAG4AZQB0AAcACAD7qrDJRlzVAQAAAAA=</b><br></code><br>5. Base64-decode the value and review it for internal domain names. Note that not all characters will be printable:<br><br><code><i>Example:</i><br><b>&#35; echo &quot;TlRMTVNTUAACAAAABgAGADgAAAAFgomiwRzZSRUKShsAAAAAAAAAAK4ArgA+AAAACgA5OAAAAA9BAE0AUwACAAYAQQBNAFMAAQASAFcAMAAwADkANQBBAFAAMgAwAAQAIgBhAG0AcwAuAGIAbgB5AG0AZQBsAGwAbwBuAC4AbgBlAHQAAwA2AFcAMAAwADkANQBBAFAAMgAwAC4AYQBtAHMALgBiAG4AeQBtAGUAbABsAG8AbgAuAG4AZQB0AAUAGgBiAG4AeQBtAGUAbABsAG8AbgAuAG4AZQB0AAcACAD7qrDJRlzVAQAAAAA=&quot; | base64 -d</b><br>NTLMSSP8<br>98AMSAMSW0095AP20&quot;<b>subdomain.domain.com</b>6W0095AP20.subdomain.domain.comdomain.com<br></code><br><br><h2><b>For specific URLs use:</b></h2><br>Tool: NTLM Challengers<br>Source: https://b17zr.com/2020/02/02/ntlm-challenger/<br><br>Example<br><code><b>python3 ntlm_challenger.py 'https://autodiscover.hackin.club/autodiscover/autodiscover.xml'</b><br> <br><b><red>Target (Domain): HACKIN</red></b><br><b><red> </red></b><br><b><red>Version: Server 2012 / Windows 8 (build 9200)</red></b><br> <br><b><red>TargetInfo:</red></b><br><b><red>        MsvAvNbDomainName: HACKIN</red></b><br><b><red>        MsvAvNbComputerName: EXCH01</red></b><br><b><red>        MsvAvDnsDomainName: hackin.club</red></b><br><b><red>        MsvAvDnsComputerName: EXCH01.hackin.club</red></b><br><b><red>        MsvAvDnsTreeName: hackin.club</red></b><br><b><red>        MsvAvTimestamp: Nov 3, 2019 01:07:16.573170</red></b><br><b><red> </red></b><br><b><red>Negotiate Flags:</red></b><br><b><red>        NTLMSSP_NEGOTIATE_UNICODE</red></b><br><b><red>        NTLMSSP_REQUEST_TARGET</red></b><br><b><red>        NTLMSSP_NEGOTIATE_ALWAYS_SIGN</red></b><br><b><red>        NTLMSSP_TARGET_TYPE_DOMAIN</red></b><br><b><red>        NTLMSSP_NEGOTIATE_EXTENDED_SESSIONSECURITY</red></b><br><b><red>        NTLMSSP_NEGOTIATE_TARGET_INFO</red></b><br><b><red>        NTLMSSP_NEGOTIATE_VERSION</red></b><br></code><br><h2><b>For direct protocol access check use:</b></h2><br>Tool: Nmap<br>Run the following nmap scripts to identify domain information:<br><br>Note: Grab targets from informational findings based on the protocol.<br>For example make sure to target all web servers listed under the finding &quot;HTTP - Service Uses Protocol&quot;.<br> <br><code>nmap -p80,443 --script http-ntlm-info -iL hosts -oA nmap-NTLM-HTTP<br>nmap -p1433 --script ms-sql-ntlm-info -iL hosts -oA nmap-NTLM-SQL<br>nmap -p143,993 --script imap-ntlm-info -iL hosts -oA nmap-IMAP-NTLM<br>nmap -p119,433,563 --script nntp-ntlm-info -iL hosts -oA nmap-NNTP-NTLM<br>nmap -p110,995 --script pop3-ntlm-info -iL hosts -oA nmap-POP3-NTLM<br>nmap -p25,465,587 --script smtp-ntlm-info -iL hosts -oA nmap-SMTP-NTLM<br>nmap -p23 --script telnet-ntlm-info -iL hosts -oA nmap-TELNET-NTLM<br>nmap -p3389 --script rdp-ntlm-info -iL hosts -oA nmap-RDP-NTLM<br>nmap -p445 --script smb-os-discovery -iL hosts -oA nmap-SMB-NTLM<br></code><br><br>AIO:<br><code>nmap -p80,443 --script http-ntlm-info -iL hosts -oA nmap-NTLM-HTTP &amp;&amp; nmap -p1433 --script ms-sql-ntlm-info -iL hosts -oA nmap-NTLM-SQL &amp;&amp; nmap -p143,993 --script imap-ntlm-info -iL hosts -oA nmap-IMAP-NTLM &amp;&amp; nmap -p119,433,563 --script nntp-ntlm-info -iL hosts -oA nmap-NNTP-NTLM &amp;&amp; nmap -p110,995 --script pop3-ntlm-info -iL hosts -oA nmap-POP3-NTLM &amp;&amp; nmap -p25,465,587 --script smtp-ntlm-info -iL hosts -oA nmap-SMTP-NTLM &amp;&amp; nmap -p23 --script telnet-ntlm-info -iL hosts -oA nmap-TELNET-NTLM &amp;&amp; nmap -p3389 --script rdp-ntlm-info -iL hosts -oA nmap-RDP-NTLM &amp;&amp; nmap -p445 --script smb-os-discovery -iL hosts -oA nmap-SMB-NTLM<br></code><br><h2><b>RDP (Only in restricted Admin mode)</b></h2><br>Below are some common tools that can be used:<br><br><b>Metasploit</b><br>https://www.rapid7.com/db/modules/auxiliary/scanner/http/ntlm_info_enumeration<br>https://www.rapid7.com/db/modules/auxiliary/scanner/http/owa_ews_login <br><br><b>Nmap</b><br>https://github.com/GDSSecurity/Nmap-Scripts/tree/master/NTLM-Info-Disclosure<br>https://nmap.org/nsedoc/scripts/http-ntlm-info.html<br>https://nmap.org/nsedoc/scripts/imap-ntlm-info.html<br>nmap -p443,80 --script http-ntlm-info -iL hosts<br>nmap -v -Pn -sS -p443 -script http-ntlm-info -script-args http-ntlm-info.root=/abs/ dialin.contoso.com<br><br>NetSPI<br>https://github.com/NetSPI/NTLMHTTPparser<br><br><b>Reporting Requirements</b><br><br>Please include the tool output or a list of enumerated Active Directory domains in the task details/notes.<br>","remediationInstructions":"If NTLM authentication is not required for a defined business purpose it should be disabled on the service.  If it is required, consider using an alternative method for authentication so internal host and Active Directory domain information cannot be leaked to unauthenticated users.<br>","name":"Information Disclosure - NTLM Response - Domain Information","sourceId":"M:4e6074fa-3bde-46ce-a658-491aee041aaf","severity":"Low","businessImpact":"The information recovered by parsing the NTLM authentication response from the server could  be used in other attacks that lead to unauthorized system, application, and data access.","description":"The remote service supports NTLM authentication.  By sending an authentication request to the server and parsing the response it is possible to recover the hostname and the Active Directory domain name of the remote server.<br>"}}}